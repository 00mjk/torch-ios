#!/bin/bash

# install prefix
PREFIX=@Torch_INSTALL_BIN@

# import:
# this function is a python-like loader, it requires a module,
# and then imports all its symbols globally
IMPORTF="\
function import(package, forced) \
   require(package) \
   if _G[package] then \
      _G._torchimport = _G._torchimport or {} \
      _G._torchimport[package] = _G[package] \
   end \
   for k,v in pairs(_G[package]) do \
      if not _G[k] or forced then \
         _G[k] = v \
      end \
   end \
end \
"

TOOLS="\
torch.include('torch','torch.lua') \
"
# by default, import torch globally
IMPORT_TORCH="import 'torch'"
IMPORT_PLOT="import 'gnuplot'"
IMPORT_DOK="require 'dok'"

# nicer prompt (self-promotion) + copyright
PROMPT="_PROMPT='torch> ' _PROMPT2=' ... > '"
COPYRIGHT="print 'Torch 7.0  Copyright (C) 2001-2011 Idiap, NEC Labs, NYU'"

# concat all symbols defined above
INIT="$COPYRIGHT $PROMPT $IMPORTF $IMPORT_TORCH $IMPORT_LAB $IMPORT_PLOT $IMPORT_DOK $TOOLS" # $PRINT $WHO"

# try to run qlua, and default to lua if not available
# all the functions defined above are executed before
# returning to a user prompt
if [ -f $PREFIX/qlua ]; 
then 
    if [ $DISPLAY ];
    then
        echo "Try the IDE: torch -ide"
        echo "Type help() for more info"
        $PREFIX/qlua -e "$INIT" -i $*;
    else
        echo "Unable to connect X11 server (disabling graphics)"
        echo "Type help() for more info"
        $PREFIX/qlua -nographics -e "$INIT" -i $*;
    fi
else 
    echo "Install Qt4 and rebuild Torch7 for graphics capability"
    echo "Type help() for more info"
    $PREFIX/lua -e "$INIT" -i $*;
fi
